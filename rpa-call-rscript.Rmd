---
layout: page
title: "RPA - 자동화(Automation)"
subtitle: "GitHub Action: R 프로그램 호출"
output:
  html_document:
    includes:
      in_header: header.html
      after_body: footer.html
    theme: default
    toc: yes
    toc_float: true
    highlight: tango
    code_folding: show
    number_sections: TRUE
mainfont: NanumGothic
editor_options: 
  chunk_output_type: console
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE,
                      comment="", digits = 3, tidy = FALSE, prompt = FALSE, fig.align = 'center')
```

# 환경 작성

```{r code-table}
library(httr)
library(glue)
library(jsonlite)
library(tidyverse)

KMA_KEY <- "l83LlqFLUxoCdqYEGwjniUL%2BMWq%2FXbSZBRgFI9YUqvzx03l9ln9DRSjgwYJZ%2BqFON10B286GcOdbBUsvBFm0XA%3D%3D"

code_table <- tribble(~"category", ~"항목명", ~"단위", 
                      "POP", "강수확률", "%",
                      "PTY", "강수형태", "코드값",
                      "R06", "6시간 강수량", "범주 (1 mm)",
                      "REH", "습도", "%",
                      "S06", "6시간 신적설", "범주(1 cm)",
                      "SKY", "하늘상태", "코드값",
                      "T3H", "3시간 기온", "℃",
                      "TMN", "아침 최저기온", "℃",
                      "TMX", "낮 최고기온", "℃",
                      "UUU", "풍속(동서성분)", "m/s",
                      "VVV", "풍속(남북성분)", "m/s",
                      "WAV", "파고", "M",
                      "VEC", "풍향", "m/s",
                      "WSD", "풍속", "1")


## 날짜 전처리
today_date <- Sys.Date() %>%  as.character() %>% 
  str_remove_all(pattern = "-")

## RESTful 호출
bundang_kma_url <- glue("http://apis.data.go.kr/1360000/VilageFcstInfoService/getVilageFcst?serviceKey={KMA_KEY}&numOfRows=10&pageNo=1&base_date={today_date}&base_time=0230&nx=62&ny=122&dataType=JSON")

bundang_resp <- GET(bundang_kma_url)

## JSON --> 데이터프레임 변환
bundang_list <- jsonlite::fromJSON(content(bundang_resp, "text"), simplifyVector = FALSE)

bundang_df <- data.frame(Reduce(rbind, bundang_list$response$body$items$item)) %>% 
  as_tibble() %>% 
  mutate_all(unlist)

## 데이터프레임 가독성 있게 표현
bundang_df %>% 
  left_join(code_table, by="category") %>% 
  select(fcstDate, fcstTime, category, 항목명, fcstValue, 단위)
```
